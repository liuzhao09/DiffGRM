# DIFF_GRM Model Configuration
model: DIFF_GRM

# SID Configuration
n_digit: 4
codebook_size: 256
share_embeddings: true

# Model Architecture
encoder_n_layer: 2
decoder_n_layer: 2
n_head: 4
n_embd: 256
n_inner: 512
dropout: 0.1
embd_pdrop: 0.1
attn_pdrop: 0.1
resid_pdrop: 0.1

# Normalization
norm_type: layernorm    # å¯é€‰: layernorm | rmsnorm
norm_eps: 1e-5          # å»ºè®®: RMSNorm=1e-6, LayerNorm=1e-5

# Output Layer Configuration
share_decoder_output_embedding: true   # ä½¿ç”¨å…±äº«embedding dot-productï¼Œfalseæ—¶å›é€€åˆ°ç‹¬ç«‹Linear

# â”€â”€â”€ æ–°å¢ï¼šè¦åœ¨éªŒè¯/æµ‹è¯•é˜¶æ®µè·‘çš„ beam æ¨¡å¼ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
beam_search_modes: ["confidence", "random"]   # é¡ºåºå†³å®šæ—¥å¿—å±•ç¤ºé¡ºåº
# å¦‚æœåªæƒ³å¶å°”è·‘ randomï¼ŒæŠŠå®ƒåˆ æ‰å³å¯

# â”€â”€â”€ æ–°å¢ï¼šrandom-beam çš„é‡‡æ ·è¶…å‚ï¼ˆç¤ºä¾‹ï¼‰ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
random_beam:
  beam_act: 64        # ğŸ‘ˆ ä½ è¦çš„ "random_beam_size"
  beam_max: 64
  seed: 42            # ä¿ç•™ï¼Œç”¨æ¥å›ºå®šéšæœºåˆ—é¡ºåº

# Generation - å‘é‡åŒ–Beam Searché…ç½®ï¼ˆç»Ÿä¸€ç®¡ç†ï¼‰
vectorized_beam_search:
  # === é€šç”¨é…ç½® ===
  top_k_final: 10                  # æœ€ç»ˆè¿”å›çš„åºåˆ—æ•°é‡
  neg_inf_fp32: -1000000000.0      # FP32è´Ÿæ— ç©·å€¼ (-1e9)
  neg_inf_fp16: -65504.0           # FP16è´Ÿæ— ç©·å€¼
  dedup_strategy: simple            # å»é‡ç­–ç•¥ï¼šsimple | weighted | none

  # === split-specificé…ç½® ===
  # éªŒè¯æ—¶ä½¿ç”¨è¾ƒå°çš„beam sizeï¼Œä¿è¯é€Ÿåº¦
  val:     {beam_act: 32,  beam_max: 32}
  # æµ‹è¯•æ—¶ä½¿ç”¨è¾ƒå¤§çš„beam sizeï¼Œä¿è¯ç²¾åº¦
  test:    {beam_act: 256, beam_max: 256}
  
  # â†“å¯ç•™å¯åˆ ï¼Œçº¯å…¼å®¹æ—§ä»£ç 
  beam_act: 32
  beam_max: 32

# å…¼å®¹æ€§å‚æ•°ï¼ˆä¿ç•™ç”¨äºæ—§ä»£ç ï¼‰
beam_size: 10
max_generation_len: 4

# Diffusion Configuration
# === Mask-Augment ç›¸å…³ ===
masking_strategy: sequential      # random | sequential | guided

# sequential è¿è´¯è§†å›¾
sequential_steps: auto        # auto(=n_digit) æˆ– 1~n_digit çš„æ•´æ•°ï¼ˆå»ºè®®â‰¤n_digit-1ä»¥è·³è¿‡å…¨æ­å¼€è§†å›¾ï¼‰
sequential_paths: 1           # åŒä¸€ä¸ªæ ·æœ¬å¹¶è¡Œå¤šå°‘æ¡éšæœºè·¯å¾„ï¼ˆä»…sequentialæ¨¡å¼æœ‰æ•ˆï¼‰

# guided ç½®ä¿¡åº¦å¼•å¯¼çš„è¿è´¯è§†å›¾
guided_steps: auto            # auto(=n_digit) æˆ– 1~n_digit
guided_conf_metric: msp       # msp | entropy
guided_refresh_each_step: false  # æ˜¯å¦æ¯æ­¥åˆ·æ–°ä¸€æ¬¡ç½®ä¿¡åº¦ï¼ˆtrueæ›´å‡†ï¼Œfalseæ›´å¿«ï¼‰
guided_select: most           # most | least  (æ­ç¤ºæœ€æœ‰æŠŠæ¡/æœ€ä¸æŠŠæ¡çš„ä½ç½®)

# random éšæœºæ©ç 
# æ–°æ–¹å¼ï¼šæŒ‰åŒºé—´éšæœºé‡‡æ ·æ©ç ç‡ï¼ˆLLaDAå¼è®­ç»ƒç¨³å®šåŒ–ï¼‰ï¼Œä¸ mask_probs äº’æ–¥
mask_prob_random: false
mask_prob_random_min: 0.0
mask_prob_random_max: 1.0

# æŒ‡å®šå¤šæ¦‚ç‡æ©ç ï¼ˆä¼˜å…ˆçº§é«˜äº mask_probï¼‰ï¼Œå¦‚ "1.0,0.75,0.5,0.25"ï¼›ä¸ä½¿ç”¨è¯·ç½®ä¸º null
mask_probs: null

# æ—§æ–¹å¼ï¼šå•ä¸€æ©ç é…ç½®ï¼ˆä½œä¸ºå¤‡é€‰ï¼‰
mask_prob: 0.5                     # è®­ç»ƒæ—¶çš„æ©ç æ¦‚ç‡ï¼ˆä»…åœ¨æœªè®¾ç½®mask_probsæ—¶ä½¿ç”¨ï¼‰
augment_factor: 4                   # æ•°æ®å¢å¼ºå€æ•°ï¼ˆä»…åœ¨æœªè®¾ç½®mask_probsæ—¶ä½¿ç”¨ï¼‰

max_history_len: 50                 # å†å²åºåˆ—æœ€å¤§é•¿åº¦

# Data Split Configuration
split: leave_one_out          # æ•°æ®åˆ’åˆ†ç­–ç•¥ï¼šleave_one_out | last_out
train_sliding: false          # æ˜¯å¦å¯¹trainåšæ»‘çª—æ‰©å……ï¼ˆtrue=æ»‘çª—ï¼Œfalse=ç»å…¸leave-one-outï¼‰
min_hist_len: 2               # æ»‘çª—æœ€çŸ­historyé•¿åº¦ï¼ˆå«labelå‰çš„åºåˆ—é•¿åº¦ï¼‰
max_hist_len: 50              # æ»‘çª—æœ€é•¿historyé•¿åº¦ï¼ˆä¸max_history_lenå¯¹é½ï¼‰

# Sentence Embedding (for SID generation)
metadata: sentence
sent_emb_model: sentence-transformers/sentence-t5-base
sent_emb_dim: 768
sent_emb_pca: 256
normalize_after_pca: true
sent_emb_batch_size: 512

# SID Quantization
# opq_pq(é»˜è®¤) | rq_kmeans | none(éšæœºæ˜ å°„)
sid_quantizer: opq_pq
rq_kmeans_niters: 20
rq_kmeans_seed: 2026
sid_random_seed: 2026

# OPQ Configuration
opq_use_gpu: False
opq_gpu_id: 0
faiss_omp_num_threads: 32
force_regenerate_opq: true  # æ˜¯å¦å¼ºåˆ¶é‡æ–°ç”ŸæˆOPQé‡åŒ–ç»“æœï¼ˆå³ä½¿å·²å­˜åœ¨ï¼‰
disable_opq: false  # æ˜¯å¦ç¦ç”¨OPQï¼Œä½¿ç”¨çº¯PQé‡åŒ–

# Training
temperature: 0.07
train_batch_size: 256
eval_batch_size: 32
lr: 0.003
weight_decay: 0.0
warmup_steps: 10000
epochs: 200
max_grad_norm: 1.0
label_smoothing: 0.1


# Evaluation
eval_interval: 1  # æ¯xxè½®è¯„ä¼°ä¸€æ¬¡ï¼Œè€Œä¸æ˜¯æ¯è½®éƒ½è¯„ä¼°
eval_start_epoch: 20  # ä»ç¬¬xxä¸ªepochå¼€å§‹è¯„ä¼°
patience: 15       # xxæ¬¡è¯„ä¼°æ— æå‡å°±æ—©åœ
min_delta: 0.0     # æå‡è‡³å°‘è¶…è¿‡è¿™ä¸ªå€¼æ‰ç®—improve
topk: [5,10]
metrics: [ndcg,recall]
val_metric: weighted_score  # ä½¿ç”¨åŠ æƒç»¼åˆæŒ‡æ ‡ï¼šweighted_score = 0.8 * ndcg_10 + 0.2 * recall_10

# â”€â”€ Auto mask schedule (off by default) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
mask_schedule:
  enabled: false

  # æ˜¾å¼ä¸¤é˜¶æ®µç®¡çº¿ï¼šStage-1 éšæœº sequentialï¼›Stage-2 guided(least)
  pipeline:
    - strategy: sequential
      sequential_steps: auto      # = n_digitï¼›è‹¥ä½ æƒ³æ›´å°‘ï¼Œå†™å…·ä½“æ•°ï¼Œå¦‚ 3
      sequential_paths: 2         # ğŸ‘ˆ å¯æ§ï¼Œ1~Nï¼ˆè¶Šå¤§æ˜¾å­˜è¶Šé«˜ï¼‰
      epochs: 10                  # è·‘ 10 ä¸ª epoch åè‡ªåŠ¨åˆ‡æ¢

    - strategy: guided
      guided_select: least        # ğŸ‘ˆ åªè¦ leastï¼Œä¸è¦ most
      guided_steps: auto          # = n_digitï¼ˆæˆ–å¡«å…·ä½“æ•°ï¼‰
      guided_conf_metric: msp     # æˆ– entropy
      guided_refresh_each_step: false
      epochs: -1                  # -1 = ç›´åˆ°è®­ç»ƒç»“æŸ/æ—©åœ

  # å»ºè®®æŠŠè¯„ä¼°é¢‘ç‡æ‹‰é«˜ï¼Œä¾¿äºå¿«é€Ÿåˆ¤æ–­"æ— æå‡"
  eval_start_epoch_override: 5  # å¼€å¯æ—¥ç¨‹æ—¶ï¼Œè¯„ä¼°ä»ç¬¬1ä¸ªepochå°±å¼€å§‹
  eval_interval_override: 1     # æ¯ä¸ªepochè¯„ä¼°ä¸€æ¬¡

# â”€â”€â”€ æ–°å¢ï¼šæ¶ˆèå¼ï¼ˆå‡å°‘æ­¥æ•°ï¼‰è§£ç å¼€å…³ä¸è¶…å‚ï¼ˆé»˜è®¤å…³é—­ï¼Œä¸å½±å“åŸæµç¨‹ï¼‰ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ablate_decode:
  enabled: false           # true=å¯ç”¨æ¶ˆèï¼›false=å®Œå…¨ä¸èµ°è¯¥åˆ†æ”¯
  per_digit_topk: null     # ç»„åˆé˜¶æ®µæ¯åˆ—å…ˆå–çš„ topLï¼›null=ç­‰åŒ beam_act
  beam:
    val:  { beam_act: 32 }
    test: { beam_act: 128 }

# â”€â”€â”€ æ–°å¢ï¼šè¯„ä¼°æ—¶å°† SID ç»„åˆæŒ‰ç°‡å±•å¼€åˆ° item å†è¯„ä¼°ï¼ˆå¯å¼€å…³ï¼‰ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
eval_expand_sid_to_items: false   # true=é¢å¤–è¾“å‡ºä¸€å¥— _xitem æŒ‡æ ‡ï¼›false=ä»…åŸSIDçº§æŒ‡æ ‡
eval_expand_dedup: first          # å±•å¼€å‰å¯¹ SID å»é‡ç­–ç•¥ï¼šfirstï¼ˆä»…ä¿ç•™é¦–æ¬¡ï¼‰